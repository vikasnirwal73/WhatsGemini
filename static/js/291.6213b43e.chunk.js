"use strict";(self.webpackChunkwhatsgemini=self.webpackChunkwhatsgemini||[]).push([[291],{291:(e,t,a)=>{a.r(t),a.d(t,{default:()=>y});var r=a(43),l=a(315),s=a(3),n=a(326),o=a(951),i=a(289),d=a(263),c=a(285),u=a(204),h=a(543),x=a(579);const g=e=>{let{isOpen:t,onClose:a,children:l,isUserMessage:s}=e;const n=(0,r.useRef)(null);return(0,r.useEffect)((()=>{const e=e=>{n.current&&!n.current.contains(e.target)&&a()};if(t)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)}),[t,a]),t?(0,x.jsx)("div",{ref:n,className:"absolute top-8 right-0 z-50 min-w-[140px] py-1 rounded-lg shadow-lg border\n        bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:l}):null},b=e=>{let{icon:t,label:a,onClick:r,disabled:l,danger:s}=e;return(0,x.jsxs)("button",{onClick:r,disabled:l,className:`w-full flex items-center gap-3 px-4 py-2 text-sm transition\n      ${l?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 dark:hover:bg-gray-700"}\n      ${s?"text-red-500":"text-gray-700 dark:text-gray-200"}`,children:[(0,x.jsx)(t,{size:14}),(0,x.jsx)("span",{children:a})]})},m=e=>{let{messages:t=[],onRegenerate:a,onEdit:l,aiLoading:s}=e;const n=(0,r.useRef)(null),[o,i]=(0,r.useState)("."),[m,p]=(0,r.useState)(null),[w,y]=(0,r.useState)(""),[f,k]=(0,r.useState)(null),v=(0,r.useMemo)((()=>{const e=t.findIndex((e=>e.role===h.aw&&e.txt&&e.txt.startsWith("Role play as, Character Name:")));return-1!==e?e+2:0}),[t]),j=(0,r.useMemo)((()=>t.slice(v)||[]),[t,v]);(0,r.useEffect)((()=>{p(null),y("")}),[t]),(0,r.useEffect)((()=>{var e;null===(e=n.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[t,s]),(0,r.useEffect)((()=>{if(s){const e=setInterval((()=>{i((e=>e.length<3?e+".":"."))}),500);return()=>clearInterval(e)}}),[s]);const N=(0,r.useCallback)((e=>{a&&a(e+v)}),[a,v]),C=(0,r.useCallback)(((e,t)=>{p(e),y(t)}),[]),E=(0,r.useCallback)((()=>{p(null),y("")}),[]),I=(0,r.useCallback)((()=>{w.trim()&&l&&(l(m+v,w.trim()),p(null),y(""))}),[w,m,l,v]),z=(0,r.useCallback)((e=>{k(f===e?null:e)}),[f]),S=(0,r.useCallback)((()=>{k(null)}),[]),M=(0,r.useCallback)((e=>{navigator.clipboard.writeText(e),S()}),[S]);return(0,x.jsxs)("div",{className:"flex-1 p-4 overflow-auto bg-app-light dark:bg-app-dark relative z-1 h-full max-w-full",children:[0===j.length?(0,x.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-center",children:"No messages yet."}):j.map(((e,t)=>(0,x.jsx)("div",{className:`flex ${e.role===h.aw?"justify-end":"justify-start"} mb-4`,children:(0,x.jsx)("div",{className:"relative p-2.5 pr-6 text-base rounded shadow-md "+(e.role===h.aw&&m===t?"w-full bg-bubble-sent-light dark:bg-bubble-sent-dark text-white":e.role===h.aw?"max-w-[90%] md:max-w-[75%] bg-bubble-sent-light dark:bg-bubble-sent-dark text-white":"max-w-[90%] md:max-w-[75%] pr-8 bg-bubble-received-light dark:bg-bubble-received-dark text-gray-900 dark:text-white"),children:e.role===h.aw&&m===t?(0,x.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,x.jsx)("textarea",{ref:e=>e&&e.focus(),value:w,onChange:e=>y(e.target.value),className:"w-full min-h-[80px] p-2 bg-white/10 text-white rounded border border-white/30 focus:border-white/60 outline-none resize-y",onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),I()),"Escape"===e.key&&E()}}),(0,x.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,x.jsx)("button",{onClick:E,className:"p-1.5 rounded bg-white/10 hover:bg-white/20 text-white/80 hover:text-white transition",title:"Cancel (Esc)",children:(0,x.jsx)(u.QCr,{size:12})}),(0,x.jsx)("button",{onClick:I,className:"p-1.5 rounded bg-white/20 hover:bg-white/30 text-white transition",title:"Save (Enter)",children:(0,x.jsx)(u.CMH,{size:12})})]})]}):(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"markdown-content text-left break-words",children:(0,x.jsx)(d.oz,{remarkPlugins:[c.A],components:{p:e=>{let{node:t,...a}=e;return(0,x.jsx)("p",{className:"mb-2 last:mb-0",...a})},em:t=>{let{node:a,...r}=t;return(0,x.jsx)("em",{className:"italic "+(e.role===h.aw?"text-white/80":"text-gray-500 dark:text-gray-400"),...r})},a:t=>{let{node:a,...r}=t;return(0,x.jsx)("a",{className:""+(e.role===h.aw?"text-white underline":"text-blue-500 hover:underline"),target:"_blank",rel:"noopener noreferrer",...r,"aria-hidden":"true"})},ul:e=>{let{node:t,...a}=e;return(0,x.jsx)("ul",{className:"list-disc ml-5 mb-2",...a})},ol:e=>{let{node:t,...a}=e;return(0,x.jsx)("ol",{className:"list-decimal ml-5 mb-2",...a})},li:e=>{let{node:t,...a}=e;return(0,x.jsx)("li",{className:"mb-1",...a})},code:e=>{let{node:t,inline:a,className:r,children:l,...s}=e;return a?(0,x.jsx)("code",{className:"bg-black/10 dark:bg-white/10 rounded px-1 py-0.5 text-sm",...s,children:l}):(0,x.jsx)("pre",{className:"bg-black/10 dark:bg-white/10 p-3 rounded-md overflow-x-auto my-2 text-sm",children:(0,x.jsx)("code",{className:r,...s,children:l})})},blockquote:t=>{let{node:a,...r}=t;return(0,x.jsx)("blockquote",{className:`border-l-4 ${e.role===h.aw?"border-white/50":"border-gray-300"} pl-4 py-1 my-2 italic`,...r})},table:t=>{let{node:a,...r}=t;return(0,x.jsx)("div",{className:"overflow-x-auto my-2",children:(0,x.jsx)("table",{className:`min-w-full divide-y ${e.role===h.aw?"divide-white/20 border-white/20":"divide-gray-200 dark:divide-gray-700 border-gray-200 dark:border-gray-700"} border`,...r})})},th:t=>{let{node:a,...r}=t;return(0,x.jsx)("th",{className:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wider border-b "+(e.role===h.aw?"bg-white/10 border-white/20 text-white":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-300"),...r})},td:t=>{let{node:a,...r}=t;return(0,x.jsx)("td",{className:"px-3 py-2 whitespace-nowrap text-sm border-b "+(e.role===h.aw?"border-white/20 text-white":"border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300"),...r})}},children:e.txt})}),(0,x.jsxs)("div",{className:"absolute top-1 right-1",children:[(0,x.jsx)("button",{onClick:()=>z(t),className:"p-1.5 rounded-full transition "+(e.role===h.aw?"text-white/60 hover:text-white hover:bg-white/10":"text-gray-400 hover:text-gray-600 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700"),title:"More options","aria-label":"Message options",children:(0,x.jsx)(u.H_v,{size:12})}),(0,x.jsxs)(g,{isOpen:f===t,onClose:S,isUserMessage:e.role===h.aw,children:[(0,x.jsx)(b,{icon:u.paH,label:"Copy",onClick:()=>M(e.txt)}),e.role===h.AI&&(0,x.jsx)(b,{icon:u.Swo,label:"Regenerate",onClick:()=>{N(t),S()},disabled:s}),e.role===h.aw&&(0,x.jsx)(b,{icon:u.uO9,label:"Edit",onClick:()=>{C(t,e.txt),S()},disabled:s})]})]})]})})},t))),s&&(0,x.jsx)("div",{className:"flex justify-start",children:(0,x.jsxs)("div",{className:"text-sm text-gray dark:text-white italic",children:["typing",o]})}),(0,x.jsx)("div",{ref:n})]})},p=e=>{let{onSend:t,disabled:a=!1}=e;const[l,s]=(0,r.useState)(""),n=(0,r.useRef)(null),o=(0,r.useCallback)((()=>{if(a)return;const e=l.trim();e&&(t(e),s(""))}),[l,t,a]),i=(0,r.useCallback)((()=>{setTimeout((()=>{var e;null===(e=n.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"center"})}),300)}),[]),d=l.trim()&&!a;return(0,x.jsxs)("div",{className:"p-3 pb-safe flex items-center bg-panel-light dark:bg-panel-dark border-t border-gray-200 dark:border-gray-800 flex-shrink-0",children:[(0,x.jsx)("input",{ref:n,value:l,onChange:e=>s(e.target.value),placeholder:a?"Waiting for response...":"Type a message...",className:"flex-1 mr-3 px-4 py-3 bg-app-light dark:bg-app-dark text-black dark:text-white rounded-full border border-transparent focus:border-primary outline-none text-base transition-colors disabled:opacity-50",disabled:a,onFocus:i,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),o())},"aria-label":"Message input","aria-busy":a}),(0,x.jsx)("button",{onClick:o,className:"p-3 rounded-full transition shadow-md "+(d?"bg-primary hover:bg-primary-hover text-white transform hover:scale-105":"bg-gray-200 dark:bg-gray-800 text-gray-400 cursor-not-allowed"),disabled:!d,title:"Send Message","aria-label":"Send Message",children:(0,x.jsx)(u.Cer,{size:16,className:d?"ml-0.5":""})})]})},w=e=>{let{character:t,onBack:a,onExport:r}=e;return(0,x.jsxs)("div",{className:"flex items-center justify-between p-3 bg-panel-light dark:bg-panel-dark text-black dark:text-white border-b border-gray-200 dark:border-gray-800 shadow-sm z-10",children:[(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsx)("button",{onClick:a,className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-600 dark:text-gray-300",title:"Back",children:(0,x.jsx)(u.QVr,{size:18})}),(0,x.jsxs)("div",{className:"flex items-center gap-3 ml-3",children:[(0,x.jsx)(u.x$1,{size:28,className:"text-white"}),(0,x.jsx)("h2",{className:"text-lg font-semibold",children:t||"Chat"})]})]}),(0,x.jsx)("button",{onClick:r,className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-600 dark:text-gray-300",title:"Export Chat",children:(0,x.jsx)(u.WCW,{size:18})})]})},y=()=>{const{chatId:e}=(0,l.g)(),t=(0,l.Zp)(),a=(0,s.wA)(),d=(0,s.d4)((e=>e.chat.chats)),c=(0,s.d4)((e=>e.ai.loading)),[u,g]=(0,r.useState)([]),[b,y]=(0,r.useState)(""),[f,k]=(0,r.useState)(null),v=(0,r.useMemo)((()=>e?Number(e):null),[e]);(0,r.useEffect)((()=>{if(!v)return;(async()=>{try{await a((0,n.JO)(v)).unwrap(),await a((0,n.Oz)()).unwrap()}catch(e){console.error("Error fetching chat data:",e),k("Failed to load chat. Please try again.")}})()}),[a,v]),(0,r.useEffect)((()=>{if(v&&null!==d&&void 0!==d&&d.length){const e=d.find((e=>e.id===v));e&&(g(e.content),y(e.title))}}),[v,d]),(0,r.useEffect)((()=>{var e;u.length>0&&null!==(e=u[0])&&void 0!==e&&e.characterId&&a((0,o.CX)(u[0].characterId))}),[a,u]);const j=e=>e.map((e=>({role:e.role===h.aw?h.m3:h.A2,parts:[{text:e.txt}]})));return(0,x.jsxs)("div",{className:"flex flex-col w-full h-dvh-minus-header chat-container bg-app-light dark:bg-app-dark",children:[(0,x.jsx)(w,{character:b,onBack:()=>{var e;const a=null===(e=window.history.state)||void 0===e?void 0:e.idx;"number"===typeof a&&a>0?t(-1):t("/",{replace:!0})},onExport:()=>{if(!v||!d)return;const e=d.find((e=>e.id===v));if(!e)return;const{id:t,...a}=e,r=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),l=URL.createObjectURL(r),s=document.createElement("a");s.href=l,s.download=`chat_${e.title||"export"}_${Date.now()}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(l)}}),f&&(0,x.jsx)("p",{className:"text-red-500 text-center p-2",children:f}),(0,x.jsx)("div",{className:"flex-1 overflow-auto",children:(0,x.jsx)(m,{messages:u,onRegenerate:async e=>{if(!(e<0||e>=u.length)&&v){k(null);try{const t=u.slice(0,e);if(await a((0,n.Co)({chatId:v,newMessages:t})),!t.length||t[t.length-1].role!==h.aw)return void console.warn("Cannot regenerate without a user message.");const r=t[t.length-1].txt,l=j(t),s=await a((0,i.pL)({prompt:r,history:l}));s.payload&&await a((0,n.tj)({chatId:v,role:h.AI,text:s.payload})),a((0,n.Oz)())}catch(t){console.error("Error regenerating response:",t),k("Failed to regenerate response. Please try again.")}}},onEdit:async(e,t)=>{if(t.trim()&&v){k(null);try{const r=u.slice(0,e);await a((0,n.Co)({chatId:v,newMessages:r}));const l=(await a((0,n.tj)({chatId:v,role:h.aw,text:t}))).payload||[],s=j(l),o=await a((0,i.pL)({prompt:t,history:s}));o.payload&&await a((0,n.tj)({chatId:v,role:h.AI,text:o.payload})),a((0,n.Oz)())}catch(r){console.error("Error editing message:",r),k("Failed to edit message. Please try again.")}}},aiLoading:c})}),(0,x.jsx)(p,{onSend:async e=>{if(e.trim()&&v){k(null);try{const t=(await a((0,n.tj)({chatId:v,role:h.aw,text:e}))).payload||[],r=j(t),l=await a((0,i.pL)({prompt:e,history:r}));l.payload&&await a((0,n.tj)({chatId:v,role:h.AI,text:l.payload})),a((0,n.Oz)())}catch(t){console.error("Error sending message:",t),k("Failed to send message. Please try again.")}}},disabled:c})]})}}}]);
//# sourceMappingURL=291.6213b43e.chunk.js.map